SELECT CASE WHEN BKPF_BSID.GSBER = '1410' THEN 1
            WHEN BKPF_BSID.GSBER = '1411' THEN 2
            WHEN BKPF_BSID.GSBER = '1420' THEN 5
            WHEN BKPF_BSID.GSBER = '1421' THEN 6
            WHEN BKPF_BSID.GSBER = '' AND BKPF_BSID.BUKRS = '1410' THEN 1
            WHEN BKPF_BSID.GSBER = '' AND BKPF_BSID.BUKRS = '1420' THEN 5
       ELSE 99 END AS UNEGID,   

       BKPF_BSID.BUKRS,
       BKPF_BSID.BUPLA,
       BKPF_BSID.GJAHR,
       BKPF_BSID.KUNNR,
       BKPF_BSID.BELNR,
       BKPF_BSID.BUZEI,
       'X_' || BKPF_BSID.XBLNR AS XBLNR,
       BKPF_BSID.BLDAT,
       BKPF_BSID.ZFBDT,
       CONCAT(CONCAT(CONCAT(SUBSTR(BKPF_BSID.BLDAT,7,2),'/'),CONCAT(SUBSTR(BKPF_BSID.BLDAT,5,2), '/')),SUBSTR(BKPF_BSID.BLDAT,0,4)) AS DATAEMISSAO,
       CONCAT(CONCAT(CONCAT(SUBSTR(BKPF_BSID.ZFBDT,7,2),'/'),CONCAT(SUBSTR(BKPF_BSID.ZFBDT,5,2), '/')),SUBSTR(BKPF_BSID.ZFBDT,0,4)) AS DATAVENCIMENTO,
       BKPF_BSID.PSWBT,
       BKPF_BSID.WSKTO,
       CASE WHEN BKPF_BSID.SHKZG = 'H' THEN 'C'
            ELSE 'D' END AS SHKZG,

       CASE WHEN (LOCATE(BKPF_BSID.XBLNR,'-', -1)) > 0 THEN BKPF_BSID.ZUONR
       ELSE '' END AS ZUONR,
       SUBSTRING(BKPF_BSID.ZUONR,1,LOCATE(BKPF_BSID.ZUONR,'-', -1)-1) AS FINANCEIROID,

       --SUBSTRING(BKPF_BSID.XBLNR,LOCATE(BKPF_BSID.XBLNR,'-', -1)+1, 2) AS ITEM,
       
       CASE WHEN SUBSTRING(BKPF_BSID.ZUONR,1,LOCATE(BKPF_BSID.ZUONR,'-', -1)-1) = '' THEN 0
            ELSE SUBSTRING(BKPF_BSID.ZUONR,LOCATE(BKPF_BSID.ZUONR,'-', -1)+1, 2) END AS ITEM,
       CURRENT_UTCDATE,
       CURRENT_TIMESTAMP         
            
FROM BKPF_BSID
JOIN BSID 
ON   BSID.MANDT = BKPF_BSID.MANDT 
AND  BSID.BUKRS = BKPF_BSID.BUKRS 
AND  BSID.GJAHR = BKPF_BSID.GJAHR 
AND  BSID.KUNNR = BKPF_BSID.KUNNR
AND  BSID.BELNR = BKPF_BSID.BELNR 
AND  BSID.BUZEI = BKPF_BSID.BUZEI

JOIN KNA1
ON   KNA1.KUNNR = BKPF_BSID.KUNNR

LEFT OUTER JOIN T012
ON   T012.MANDT = BKPF_BSID.MANDT 
AND  T012.HBKID = BKPF_BSID.HBKID

LEFT OUTER JOIN BNKA
ON   BNKA.MANDT = T012.MANDT 
AND  BNKA.BANKL = T012.BANKL

LEFT OUTER JOIN REGUP
ON   REGUP.MANDT = BKPF_BSID.MANDT
AND  REGUP.VBLNR = BKPF_BSID.ANFBN
AND  REGUP.BUKRS = BKPF_BSID.ANFBU
AND  REGUP.GJAHR = BKPF_BSID.GJAHR
AND  REGUP.KUNNR = BKPF_BSID.KUNNR
AND  REGUP.BELNR = BKPF_BSID.BELNR 
AND  REGUP.BUZEI = BKPF_BSID.BUZEI

WHERE 1=1
AND   BKPF_BSID.UMSKS = ''
--AND   BKPF_BSID.BELNR = '1000000002'

ORDER BY
BKPF_BSID.KUNNR,
BKPF_BSID.BLDAT,
BKPF_BSID.BELNR,
BKPF_BSID.BUZEI;
